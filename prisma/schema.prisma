// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  admin
  manager
  technician
  user
}

model User {
  id         String   @id @default(cuid())
  name       String
  email      String   @unique
  role       UserRole
  department String
  avatar     String?
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  managedDepartments Department[]    @relation("DepartmentManager")
  assignedAssets     Asset[]         @relation("AssetAssignment")
  licenses           License[]
  movementsFrom      AssetMovement[] @relation("MovementFromUser")
  movementsTo        AssetMovement[] @relation("MovementToUser")
  movementTechnician AssetMovement[] @relation("MovementTechnician")
  maintenances       Maintenance[]   @relation("MaintenanceTechnician")
  requestedTickets   Ticket[]        @relation("TicketRequester")
  assignedTickets    Ticket[]        @relation("TicketAssignee")
  ticketComments     TicketComment[]

  @@map("users")
}

model Department {
  id         String @id @default(cuid())
  name       String
  costCenter String
  managerId  String
  location   String

  // Relations
  manager  User      @relation("DepartmentManager", fields: [managerId], references: [id])
  assets   Asset[]
  licenses License[]

  @@map("departments")
}

enum AssetType {
  desktop
  laptop
  server
  network
  mobile
  printer
  other
}

enum AssetStatus {
  available
  in_use
  maintenance
  retired
  lost
}

model Asset {
  id                  String      @id @default(cuid())
  name                String
  type                AssetType
  status              AssetStatus
  serialNumber        String      @unique
  manufacturer        String
  model               String
  purchaseDate        DateTime
  warrantyExpiry      DateTime
  purchasePrice       Float
  currentValue        Float
  departmentId        String
  assignedToId        String?
  location            String
  specifications      Json
  notes               String?
  lastMaintenanceDate DateTime?
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  // Relations
  department   Department      @relation(fields: [departmentId], references: [id])
  assignedTo   User?           @relation("AssetAssignment", fields: [assignedToId], references: [id])
  movements    AssetMovement[]
  maintenances Maintenance[]
  tickets      Ticket[]

  @@map("assets")
}

enum AssetMovementType {
  allocation
  maintenance
  transfer
  creation
}

model AssetMovement {
  id           String            @id @default(cuid())
  type         AssetMovementType
  assetId      String
  fromUserId   String?
  toUserId     String?
  technicianId String?
  fromLocation String
  toLocation   String?
  movementDate DateTime
  reason       String
  authorizedBy String
  notes        String?

  // Relations
  asset      Asset @relation(fields: [assetId], references: [id])
  fromUser   User? @relation("MovementFromUser", fields: [fromUserId], references: [id])
  toUser     User? @relation("MovementToUser", fields: [toUserId], references: [id])
  technician User? @relation("MovementTechnician", fields: [technicianId], references: [id])

  @@map("asset_movements")
}

enum MaintenanceType {
  preventive
  corrective
  upgrade
  cleaning
  inspection
}

model Maintenance {
  id              String          @id @default(cuid())
  maintenanceType MaintenanceType
  maintenanceDate DateTime
  nextMaintenance DateTime?
  technicianId    String?
  assetId         String
  cost            Float?
  description     String
  notes           String?
  createdAt       DateTime        @default(now())

  // Relations
  asset      Asset @relation(fields: [assetId], references: [id])
  technician User? @relation("MaintenanceTechnician", fields: [technicianId], references: [id])

  @@map("maintenances")
}

// Ticket enums and models

enum TicketPriorityType {
  low
  medium
  high
  critical
}

enum TicketStatusType {
  open
  in_progress
  pending
  resolved
  closed
}

enum TicketCategoryType {
  hardware
  software
  network
  access
  other
}

model Ticket {
  id                      String             @id @default(cuid())
  title                   String
  description             String
  category                TicketCategoryType
  priority                TicketPriorityType
  status                  TicketStatusType
  requesterId             String
  requester               User               @relation("TicketRequester", fields: [requesterId], references: [id])
  assignedToId            String?
  assignedTo              User?              @relation("TicketAssignee", fields: [assignedToId], references: [id])
  assetId                 String?
  asset                   Asset?             @relation(fields: [assetId], references: [id])
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt
  resolvedAt              DateTime?
  resolution              String?
  estimatedResolutionDate DateTime?

  // Relations
  comments TicketComment[]

  @@map("tickets")
}

model TicketComment {
  id         String   @id @default(cuid())
  ticketId   String
  userId     String
  comment    String
  isInternal Boolean
  createdAt  DateTime @default(now())

  // Relations
  ticket Ticket @relation(fields: [ticketId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@map("ticket_comments")
}

enum LicenseType {
  perpetual
  subscription
  concurrent
  named_user
}

model License {
  id           String      @id @default(cuid())
  softwareName String
  vendor       String
  licenseType  LicenseType
  licenseKey   String
  totalSeats   Int
  purchaseDate DateTime
  expiryDate   DateTime?
  annualCost   Int
  departmentId String
  notes        String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  // Relations
  department Department @relation(fields: [departmentId], references: [id])
  users      User[]

  @@map("licenses")
}
